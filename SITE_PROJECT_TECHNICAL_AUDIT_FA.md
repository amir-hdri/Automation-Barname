# گزارش فنی تکمیلی: بررسی سایت بارنامه + مشکلات پروژه + اقدامات انجام‌شده

## 1) هدف گزارش
این گزارش برای مستندسازی دقیق موارد زیر تهیه شده است:
- بررسی فنی رفتار واقعی سایت بارنامه (`barname.utcms.ir`)
- تحلیل مشکلات شناسایی‌شده در پروژه اتوماسیون
- شرح اصلاحات انجام‌شده روی کد
- وضعیت فعلی آمادگی عملیاتی پروژه

تاریخ گزارش: **2026-02-27**

---

## 2) خلاصه اجرایی
- پروژه از نظر کدنویسی و تست، پایدار و قابل استقرار شده است.
- نسخه آماده GitHub تولید و پاک‌سازی شده است.
- تست کامل نسخه نهایی پاس شده: **84 passed**.
- دو مانع اصلی بیرونی (خارج از کد) همچنان وجود دارد:
  1. دسترسی حساب کاربری به ماژول صدور بارنامه
  2. ناپایداری DNS/شبکه برای دامنه `barname.utcms.ir`

---

## 3) شواهد فنی بررسی سایت بارنامه

### 3.1) ناپایداری DNS و دسترسی شبکه
در snapshot شبکه در تاریخ **2026-02-27 17:56:45 +0330**:
- `nslookup barname.utcms.ir` در 3 تلاش متوالی: `SERVFAIL`
- `curl -I https://barname.utcms.ir/Login` در 3 تلاش: `Could not resolve host`

نتیجه فنی:
- ارتباط با سایت در برخی بازه‌ها ناپایدار است.
- این ایراد در لایه اینترنت/DNS رخ می‌دهد و مستقیماً قابل حل در کد برنامه نیست، اما باید با retry/backoff مدیریت شود (که در پروژه اعمال شده است).

### 3.2) وضعیت دسترسی حساب به ماژول بارنامه
در اجرای عملی endpoint ثبت بارنامه:
- پاسخ API: `400`
- خطا: `حساب کاربری به ماژول صدور بارنامه دسترسی ندارد`
- الگوی صفحه: هدایت به `Home/InfoIndex` و نمایش پیام/لینک درخواست دسترسی

نتیجه فنی:
- ربات به مرحله فرم صدور نمی‌رسد چون مجوز ماژول سمت سامانه برای این حساب فعال نیست.

---

## 4) مشکلات پروژه (قبل از اصلاح)

### 4.1) خطاهای Async/Mock در مسیر auth و waybill
- خطاهای `TypeError: argument of type 'coroutine' is not iterable`
- اثر: شکست تست‌ها و رفتار ناپایدار در تشخیص URL/title

### 4.2) مدیریت ناکافی صفحات خطا/Not Found
- ربات در برخی سناریوها وارد صفحات `یافت نشد` یا `خطا در سامانه` می‌شد و مسیر بازیابی کامل نبود.

### 4.3) خطاهای عمومی مبهم (500)
- بخشی از خطاهای عملیاتی شبکه/سایت با `500` عمومی بازمی‌گشتند و اقدام‌پذیری پایین بود.

### 4.4) پایداری پایین در `page.goto`
- برای خطاهای موقتی شبکه (DNS timeout, net::*) retry سازمان‌یافته وجود نداشت.

---

## 5) اقدامات اصلاحی انجام‌شده

### 5.1) اصلاح هسته auth و مدیریت async
فایل:
- `app/automation/auth.py`

اقدامات:
- افزودن resolve امن برای مقادیر awaitable/mock
- پایدارسازی تشخیص لاگین/URL
- افزودن `goto` با retry نمایی + jitter برای URLهای لاگین و waybill

### 5.2) مقاوم‌سازی flow صدور بارنامه
فایل:
- `app/automation/waybill_enhanced.py`

اقدامات:
- `goto` مقاوم به اختلال شبکه
- بهبود تشخیص صفحات خطا/یافت نشد
- بازیابی با مسیرهای جایگزین و URL candidate
- تشخیص صریح نبود دسترسی ماژول صدور
- پیام خطای دقیق و قابل اقدام

### 5.3) بهبود سرویس API و دسته‌بندی خطاها
فایل:
- `app/services/waybill_service.py`

اقدامات:
- retry برای خطاهای موقتی
- تبدیل خطاهای شبکه به `503` با پیام عملیاتی
- تفکیک failure category به `network`/`form`/`auth`

### 5.4) افزودن لایه مرکزی تشخیص خطای شبکه
فایل جدید:
- `app/core/network.py`

اقدامات:
- تعریف markerهای جامع برای DNS/timeout/connection
- تابع واحد `is_retryable_network_error`

### 5.5) تنظیمات عملیاتی جدید
فایل:
- `app/core/config.py`
- `env.example`

اقدامات:
- افزودن پارامترهای retry برای `goto`:
  - `PAGE_GOTO_MAX_RETRIES`
  - `PAGE_GOTO_RETRY_BASE_SECONDS`
  - `PAGE_GOTO_RETRY_JITTER_SECONDS`
- پیش‌فرض `HEADLESS=false` جهت اجرای تعاملی/قابل مشاهده

---

## 6) پاک‌سازی حرفه‌ای پروژه برای GitHub

خروجی آماده:
- فولدر نهایی: `/Users/amirheidari/Desktop/bar22/utcms-automation-github-ready`
- ZIP نهایی: `/Users/amirheidari/Desktop/bar22/utcms-automation-github-ready.zip`

پاک‌سازی انجام‌شده:
- حذف `.venv`, `.pytest_cache`, `.auth`, `__pycache__`, `*.pyc`, `*.db`, snapshotها
- کاهش حجم پروژه از حدود `211M` به حدود `540K` در نسخه نهایی

---

## 7) اعتبارسنجی کیفیت
- اجرای تست کامل روی نسخه نهایی پاک‌سازی‌شده:
  - **84 passed in 50.89s**
- تست‌های جدید پایداری شبکه افزوده شده‌اند (network resilience)

---

## 8) وضعیت فعلی آمادگی عملیاتی

### آماده و انجام‌شده
- کد از نظر ساختاری و تست آماده است.
- مدیریت خطای شبکه/صفحاتی/عملیاتی به‌صورت حرفه‌ای پیاده‌سازی شده است.
- بسته GitHub-ready و گزارش فنی تولید شده است.

### موانع بیرونی باقی‌مانده
1. فعال نبودن دسترسی حساب به ماژول صدور بارنامه در UTCMS
2. ناپایداری متناوب DNS/شبکه دامنه مقصد

---

## 9) توصیه‌های اجرایی نهایی
1. برای حساب عملیاتی، دسترسی ماژول «صدور بارنامه شهری» از سمت UTCMS فعال شود.
2. اجرای production با retry فعال انجام شود (`PAGE_GOTO_*` و `WAYBILL_*`).
3. مانیتورینگ DNS/HTTP بیرونی (latency/error-rate) اضافه شود.
4. قبل از ثبت واقعی، یک اجرای `safe` اجباری در هر شیفت عملیاتی انجام شود.

---

## 10) فهرست فایل‌های کلیدی تغییر یافته
- `app/core/network.py` (جدید)
- `app/core/config.py`
- `app/automation/auth.py`
- `app/automation/waybill_enhanced.py`
- `app/services/waybill_service.py`
- `env.example`
- `tests/test_network_resilience.py` (جدید)

